---
title: "Forecasting Influenza from New York"
output: html_notebook
---

Forecasting Ne using BNPR

```{r}
library(phylodyn)
library(dplyr)
library(ggplot2)
library(PILAF)

H3N2_tree <- ape::read.nexus(system.file("extdata/H3N2/MCC.tree",
                                         package = "PILAF"))
plot(ape::ladderize(H3N2_tree),show.tip.label=FALSE)
H3N2_last_time <- 2019.0739726027398
ar2crw1_formula <- y ~ -1 + f(time, model = "ar", order = 2) +
      f(week, model = "rw1", cyclic = T, constr = F)
H3N2_Ne_forecast <- BNPR_forecast(H3N2_tree, last_time = H3N2_last_time, formula = ar2crw1_formula, pred = 20)
BNPR <- BNPR(H3N2_tree)
```

The next figure compares estimation with the AR(2)+CRW(1) (black curve) to BNPR (red curve)
```{r}
p_ar2crw1_data <- with(H3N2_Ne_forecast, data.frame(time = H3N2_last_time - result$summary.random$time$ID,
                                  mean = effpopmean, 
                                  lwr = effpop025,
                                  upr = effpop975))
BNPR_data <- with(BNPR, data.frame(time = H3N2_last_time - result$summary.random$time$ID,
                                  mean = effpopmean, 
                                  lwr = effpop025,
                                  upr = effpop975)) 
  
xmin <- c()
xmax <- c()
year <- floor(min(p_ar2crw1_data$time))
while (year < max(p_ar2crw1_data$time)) {
  xmin <- c(xmin, year + 0.9)
  xmax <- c(xmax, year + 1.2)
  year = year + 1
}
winter_seasons <- data.frame(xmin = xmin, xmax = xmax) %>%
  filter(xmin < max(p_ar2crw1_data$time) & xmax > min(p_ar2crw1_data$time))

p_ar2crw1 <- ggplot() +
  geom_rect(data = winter_seasons, aes(xmin = xmin, xmax = xmax, ymin = min(p_ar2crw1_data$lwr), ymax = max(p_ar2crw1_data$upr)), fill = 'steelblue', alpha = 0.1) +
  geom_ribbon(data = p_ar2crw1_data, aes(x = time, ymin = lwr, ymax = upr), fill = 'gray', alpha = 0.3) +
  geom_line(data = p_ar2crw1_data, aes(x = time, y = mean)) +
  theme_classic() +
  scale_y_log10() +
  geom_vline(aes(xintercept = H3N2_last_time - H3N2_Ne_forecast$result$summary.random$time$ID[21]), linetype = 'dotdash') +
  ylab('Ne') + 
  geom_line(data = BNPR_data, aes(x = time, y = mean), col = "red") 
p_ar2crw1
```

This will be the same as above but we will truncate our tree 
```{r}
H3N2_tree <- ape::read.nexus(system.file("extdata/H3N2/MCC.tree",
                                         package = "PILAF"))
H3N2_last_time <- 2019.0739726027398

truncation_time<-.08 #about 4 weeks
H3N2_truncated<-truncate_data(H3N2_tree,truncation_time)
H3N2_Ne_forecast <- BNPR_forecast(H3N2_truncated, last_time = H3N2_last_time-truncation_time, formula = ar2crw1_formula, pred = 20)

p_ar2crw1_data <- with(H3N2_Ne_forecast, data.frame(time = H3N2_last_time-truncation_time - result$summary.random$time$ID,
                                  mean = effpopmean, 
                                  lwr = effpop025,
                                  upr = effpop975))
xmin <- c()
xmax <- c()
year <- floor(min(p_ar2crw1_data$time))
while (year < max(p_ar2crw1_data$time)) {
  xmin <- c(xmin, year + 0.9)
  xmax <- c(xmax, year + 1.2)
  year = year + 1
}
winter_seasons <- data.frame(xmin = xmin, xmax = xmax) %>%
  filter(xmin < max(p_ar2crw1_data$time) & xmax > min(p_ar2crw1_data$time))

p_ar2crw1 <- ggplot() +
  geom_rect(data = winter_seasons, aes(xmin = xmin, xmax = xmax, ymin = min(p_ar2crw1_data$lwr), ymax = max(p_ar2crw1_data$upr)), fill = 'steelblue', alpha = 0.1) +
  geom_ribbon(data = p_ar2crw1_data, aes(x = time, ymin = lwr, ymax = upr), fill = 'gray', alpha = 0.3) +
  geom_line(data = p_ar2crw1_data, aes(x = time, y = mean)) +
  theme_classic() +
  scale_y_log10() +
  geom_vline(aes(xintercept = H3N2_last_time-truncation_time - H3N2_Ne_forecast$result$summary.random$time$ID[21]), linetype = 'dotdash') +
  ylab('Ne') + 
  geom_line(data = BNPR_data, aes(x = time, y = mean), col = "red") 
p_ar2crw1
```

# BNPR PS forecast

In both cases H1N1 and H3N2, effective population size estimated with preferential sampling correlates more with ILI Counts. We will forecast H3N2 and H1N1 effective population size trajectories with preferential sampling. In Figure 6, we show that different seasons have different epidemic peaks. Using a weekly cyclic component may not be helpful in this case. The goal is to forecast the next 4 weeks. 

# H3N2

```{r}
H3N2_tree <- ape::read.nexus(system.file("extdata/H3N2/MCC.tree",
                                         package = "PILAF"))
H3N2_last_time <- 2019.0739726027398

#plot regular BNPR_PS
bnpr_ps_H3N2<-BNPR_PS(H3N2_tree)
plot_BNPR(bnpr_ps_H3N2) 
###Here I really would like to visualize only the seasons like Figure (6) third row 
##It would be helpful if you can add your code for generating the seasons per year like row 3 in figure 6 with the plot() function so that I can overlay the forecasts of weeks 46-50, 2-5 and 11-15 per season

BNPR_PS_formula <- Y ~ -1 + beta0 +
        f(time, model="ar", order = 2, constr = FALSE) +
        f(time2, w, copy="time", fixed=FALSE) 

# example usage of forecast_starting
forecast_2015week46 <- forecast_starting(H3N2_tree, last_time = H3N2_last_time, week_start = 45, 
                  year_start = 2015, label = "H3N2 BNPR PS", formula = BNPR_PS_formula, pred = 5)
plot_trajectory(forecast_2015week46$df, 
                range(c(forecast_2015week46$df$Lower, forecast_2015week46$df$Upper)), 
                seq(2014, 2019), 
                H3N2_last_time - max(phylodyn::summarize_phylo(H3N2_tree)$coal_times), 
                vline = forecast_2015week46$res$truncation_time - forecast_2015week46$res$result$summary.random$time$ID[forecast_2015week46$pred + 1])

# run forecasts on a grid
seasons <- seq(2014, 2018)
week_start <- c(45, 1, 10)
preds <- rep(5, 3)
tasks <- expand.grid(year = seasons, wk_start = week_start) %>%
  arrange(year, wk_start) %>%
  filter(!(year == 2014 & wk_start < 40)) %>%
  rbind(c(2019, 1)) %>%
  mutate(pred = 5)

forecasts <- purrr::pmap(tasks, ~forecast_starting(H3N2_tree, last_time = H3N2_last_time, week_start = ..2, 
                  year_start = ..1, label = "H3N2_Ne", formula = BNPR_PS_formula, pred = ..3)$df[seq(..3),])
H3N2_forecasts <- purrr::imap(forecasts, ~mutate(.x, forecast = .y)) %>%
  dplyr::bind_rows() %>%
  mutate(week = unlist(purrr::map(tasks$wk_start, ~.x + 5:1)))
```

Overlaying the visualization on BNPR PS (no forecast)

```{r}
selected_seasons <- c("2014-2015", "2015-2016", "2016-2017", "2017-2018", "2018-2019")
H3N2_Ne_forecast <- BNPR_forecast(H3N2_tree, last_time = H3N2_last_time, formula = BNPR_PS_formula, pred = 0, pref = T)
H3N2_Ne_data <- with(H3N2_Ne_forecast, 
                     data.frame(time = H3N2_last_time - result$summary.random$time$ID,
                                week = weeks,
                                H3N2_Ne = effpopmean,
                                lwr = effpop025,
                                upr = effpop975))
H3N2_Ne_data$year <- floor(H3N2_Ne_data$time)
p_H3N2_Ne_forecast <- visualize_flu_season(H3N2_Ne_data, time_series_names = "H3N2_Ne", 
                                  subset_seasons = selected_seasons, ncol = 5, season_label = F,
                                  error_band_names = data.frame(lwr = "lwr", upr = "upr", stringsAsFactors = F),
                                  add_forecasts = H3N2_forecasts)
p_H3N2_Ne_forecast
```

# H1N1

```{r}
H1N1_tree <- ape::read.nexus(system.file("extdata/H1N1/MCC.tree",
                                         package = "PILAF"))
H1N1_last_time <- 2019.0931506849315

forecasts <- purrr::pmap(tasks, 
                         ~forecast_starting(H1N1_tree, last_time = H1N1_last_time, week_start = ..2, 
                  year_start = ..1, label = "H1N1_Ne", formula = BNPR_PS_formula, pred = ..3)$df[seq(..3),])
H1N1_forecasts <- purrr::imap(forecasts, ~mutate(.x, forecast = .y)) %>%
  dplyr::bind_rows() %>%
  mutate(week = lubridate::week(lubridate::date_decimal(Time)))

# run forecasts on a grid
H1N1_Ne_forecast <- BNPR_forecast(H1N1_tree, last_time = H1N1_last_time, formula = BNPR_PS_formula, pred = 0, pref = T)
H1N1_Ne_data <- with(H1N1_Ne_forecast, 
                     data.frame(time = H1N1_last_time - result$summary.random$time$ID,
                                week = weeks,
                                H1N1_Ne = effpopmean,
                                lwr = effpop025,
                                upr = effpop975))
H1N1_Ne_data$year <- floor(H1N1_Ne_data$time)
p_H1N1_Ne_forecast <- visualize_flu_season(H1N1_Ne_data, time_series_names = "H1N1_Ne", 
                                  subset_seasons = selected_seasons, ncol = 5, season_label = F,
                                  error_band_names = data.frame(lwr = "lwr", upr = "upr", stringsAsFactors = F),
                                  add_forecasts = H1N1_forecasts)
p_H1N1_Ne_forecast
```




```{r}
rw1_formula <- y ~ -1 + f(time, model = "rw1", constr = F) 
rw1_H3N2_Ne_forecast <- BNPR_forecast(H3N2_tree, last_time = H3N2_last_time, formula = ar2crw1_formula, pred = 20)
``` 

```{r}
p_rw1_data <- with(rw1_H3N2_Ne_forecast, data.frame(time = H3N2_last_time - result$summary.random$time$ID,
                                  mean = effpopmean, 
                                  lwr = effpop025,
                                  upr = effpop975)) 

xmin <- c()
xmax <- c()
year <- floor(min(p_rw1_data$time))
while (year < max(p_rw1_data$time)) {
  xmin <- c(xmin, year + 0.9)
  xmax <- c(xmax, year + 1.2)
  year = year + 1
}
winter_seasons <- data.frame(xmin = xmin, xmax = xmax) %>%
  filter(xmin < max(p_rw1_data$time) & xmax > min(p_rw1_data$time))

p_rw1 <-  ggplot() +
  geom_rect(data = winter_seasons, aes(xmin = xmin, xmax = xmax, ymin = min(p_rw1_data$lwr), ymax = max(p_rw1_data$upr)), fill = 'steelblue', alpha = 0.1) +
  geom_ribbon(data = p_rw1_data, aes(x = time, ymin = lwr, ymax = upr), fill = 'gray', alpha = 0.3) +
  geom_line(data = p_rw1_data, aes(x = time, y = mean)) +
  theme_classic() +
  scale_y_log10() +
  ylab('Ne') + 
  geom_vline(aes(xintercept = H3N2_last_time - H3N2_Ne_forecast$result$summary.random$time$ID[21]), linetype = 'dotdash') +
  geom_line(data = BNPR_data, aes(x = time, y = mean), col = "red")  
p_rw1
```

```{r}
library(cowplot)
p_all <- cowplot::plot_grid(
  cowplot::plot_grid(ggdraw() + draw_label('RW(1)'), p_rw1, ncol = 1, rel_heights = c(0.1, 1)), 
  cowplot::plot_grid(ggdraw() + draw_label('AR(2) + cRW(1)'), p_ar2crw1 + theme(axis.title.y = element_blank()),  rel_heights = c(0.1, 1), ncol = 1), 
  ncol = 2)
p_all
#ggsave(p_all, file = '../../projectingvirus/manuscript/Figures/Ne/forecast_Ne.pdf', width = 6, height = 3)
```
