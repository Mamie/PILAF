---
title: "Simulate and forecast ILI count trajectories"
author: "Meng Wang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulating ILI count trajectories}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo=FALSE}
knitr::opts_chunk$set(collapse=TRUE, comment="#>")
```

## AR(2) model on time vs joint AR(2) model on time and coalescent time

Simulate 10 ILI trajectories and corresponding flu sampling and coalescent counts.

```{r generate-data, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(PILAF)
n = 50
lim = c(-10, 100)
flu.Ne = function(...) phylodyn::logistic_traj(..., period = 52, offset = 26)
flu.sampNum = 100
ILI.sampNum = 1000
sim.data = PILAF::SimulateILISampCoalCountsN(n, lim, flu.Ne, flu.sampNum, ILI.sampNum)
plot(sim.data)
```

Forecast the trajectories. 

```{r forecasting, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
train.time = seq(0, 100) # given 101 weeks before and including present
test.time = seq(-10, -1) # predict 10 weeks ahead
sim.train = sim.data[sim.data$time %in% train.time,]
sim.test = sim.data[!sim.data$time %in% train.time,]
# count_fit = forecast(sim.train, test.time)
# save(count_fit, file='../../data/sandbox_RData/count_fit.RData')
load('../../data/sandbox_RData/count_fit.RData')
plot(count_fit, sim.train, truth=sim.test)
```

Evaluate the mean relative deviation and mean relative width between forecast and true trajectory for the 10 trajectories.


```{r results="asis"}
count_res = summary(count_fit, sim.test)
pander::pandoc.table(count_res[rev(1:nrow(count_res)),])
```

```{r plot-fit}
evaluate(count_fit, sim.test)
```

## Forecast combining the count and joint

```{r fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
# joint_fit = forecast(sim.train, test.time, method='joint')
# save(joint_fit, file='../../data/sandbox_RData/joint_fit.RData')
load('../../data/sandbox_RData/joint_fit.RData')
plot(joint_fit, sim.train, truth=sim.test)
```

```{r, results="asis"}
joint_res = summary(joint_fit, sim.test)
pander::pandoc.table(joint_res[rev(1:nrow(count_res)),])
```

Looking at pattern of absolute error and width. It doesn't differ a lot from the count only model. 

```{r joint-plot-fit}
evaluate(joint_fit, sim.test)
```


Let's compare the performance of the two models side by side:

```{r comparison}
PILAF::ComparePerformance(count_fit, joint_fit, sim.test, method = c('count', 'joint'))
```

Under AR(2) model, joint isn't any better compared to count only in terms of MAE and MW. 

